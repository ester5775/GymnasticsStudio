import { RxFormGroup, RxFormArray, RxFormControl, RxwebValidators } from '@rxweb/reactive-form-validators';
import { FormControlConfig } from "./form-control-config";
import { getInstance } from "../functions/get-instance.function";
import { ApplicationUtil } from "../util/application-util";
import { NotificationState } from "../statics/control-state";
const ARRAY = "array";
export class RxDynamicFormBuilder {
    formGroup(fields, dynamicFormConfig) {
        let notificationId = NotificationState.notificationId++;
        NotificationState.notifications[notificationId] = {};
        this.formConfiguration = dynamicFormConfig || {};
        let entityObject = {};
        let formFieldConfigs = new Array();
        let modelConfig = {};
        let formGroup = new RxFormGroup({}, entityObject, {}, undefined);
        fields.forEach((x, i) => {
            if (x.type == ARRAY) {
                this.createFormArray(modelConfig, x, ApplicationUtil.getRootFormGroup(formGroup), entityObject, notificationId);
            }
            else {
                let splitName = x.name.split('.');
                let name = x.name;
                if (splitName.length > 1) {
                    if (!entityObject[splitName[0]]) {
                        entityObject[splitName[0]] = {};
                        formGroup.addControl(splitName[0], new RxFormGroup({}, entityObject[splitName[0]], {}, undefined));
                        formGroup = formGroup.controls[splitName[0]];
                    }
                    else if (formGroup.controls[splitName[0]] != undefined && formGroup.controls[splitName[0]] instanceof RxFormGroup)
                        formGroup = formGroup.controls[splitName[0]];
                    name = splitName[1];
                }
                else
                    formGroup = ApplicationUtil.getRootFormGroup(formGroup);
                let modelInstance = this.getDynamicModelInstance(x, modelConfig, entityObject, name, notificationId);
                formGroup.addControl(name, modelInstance.formControl);
                formFieldConfigs.push(modelInstance);
            }
        });
        if (this.formConfiguration.additionalConfig)
            this.formConfiguration.additionalConfig.forEach(t => this.getModelInstance(t, modelConfig, notificationId));
        let rootFormGroup = ApplicationUtil.getRootFormGroup(formGroup);
        rootFormGroup["model"] = undefined;
        return {
            controlsConfig: modelConfig,
            formGroup: rootFormGroup
        };
    }
    createFormArray(modelConfig, field, formGroup, entityObject, notificationId) {
        modelConfig[field.name] = [];
        entityObject[field.name] = [];
        let formArray = new RxFormArray(entityObject[field.name], []);
        if (field.controlConfigs) {
            if (field.rows)
                field.rows.forEach(row => {
                    formArray.controls.push(this.createDynamicFormGroup(field, modelConfig[field.name], this.getRefObject(entityObject[field.name]), row, notificationId));
                });
            if (field.minimumRepeatCount && field.minimumRepeatCount > 0) {
                let countLeft = field.minimumRepeatCount - (formArray.controls.length);
                for (var i = 0; i < countLeft; i++)
                    formArray.controls.push(this.createDynamicFormGroup(field, modelConfig[field.name], this.getRefObject(entityObject[field.name]), { fields: [] }, notificationId));
            }
            this.addTwoProp(modelConfig[field.name], field, entityObject[field.name], formArray, notificationId);
            formGroup.addControl(field.name, formArray);
        }
    }
    getRefObject(entityObject) {
        let jObject = {};
        entityObject.push(jObject);
        return jObject;
    }
    addTwoProp(modelConfig, x, entityObject, formArray, notificationId) {
        modelConfig.__proto__.addItem = () => {
            formArray.controls.push(this.createDynamicFormGroup(x, modelConfig, this.getRefObject(entityObject), { fields: [] }, notificationId));
        };
        modelConfig.__proto__.removeItem = (index) => {
            formArray.removeAt(index);
            modelConfig.splice(index, 1);
        };
    }
    createDynamicFormGroup(x, modelConfig, entityObject, row, notificationId) {
        let nestedFormGroup = new RxFormGroup({}, entityObject, {}, undefined);
        let jObject = {};
        modelConfig.push(jObject);
        Object.keys(x.controlConfigs).forEach(key => {
            let field = row.fields.filter(x => x.name == key)[0];
            let formControlConfig = Object.assign({}, x.controlConfigs[key], { name: key });
            if (field)
                formControlConfig = Object.assign({}, formControlConfig, field);
            let modelInstance = this.getDynamicModelInstance(formControlConfig, jObject, entityObject, key, notificationId);
            nestedFormGroup.addControl(key, modelInstance.formControl);
        });
        return nestedFormGroup;
    }
    getModelInstance(x, modelConfig, notificationId) {
        let configModel = (x.modelName) && this.formConfiguration && this.formConfiguration.controlConfigModels ? this.formConfiguration.controlConfigModels.filter((y) => y.modelName == x.modelName)[0] : undefined;
        let modelArguments = [x, modelConfig, notificationId];
        let model = undefined;
        if (configModel) {
            model = configModel.model;
            if (configModel.arguments)
                configModel.arguments.forEach(t => modelArguments.push(t));
        }
        else
            model = FormControlConfig;
        let modelInstance = getInstance(model, modelArguments);
        modelConfig[x.name] = modelInstance;
        return modelInstance;
    }
    getDynamicModelInstance(x, modelConfig, entityObject, name, notificationId) {
        let modelInstance = this.getModelInstance(x, modelConfig, notificationId);
        let validators = [];
        let asyncValidators = [];
        if (x.validators)
            this.validatorBindings(validators, x.validators);
        if (modelInstance.validator)
            validators.push(modelInstance.validator.bind(modelInstance));
        if (modelInstance.asyncValidator)
            asyncValidators.push(modelInstance.asyncValidator.bind(modelInstance));
        if (modelInstance)
            entityObject[x.name] = x.value;
        let baseObject = {};
        baseObject[x.name] = x.value;
        entityObject[x.name] = x.value;
        modelInstance.formControl = new RxFormControl(x.value, validators, asyncValidators, entityObject, baseObject, name, undefined);
        return modelInstance;
    }
    validatorBindings(validations, validationConfig) {
        for (var column in RxwebValidators) {
            if (validationConfig[column]) {
                validations.push(RxwebValidators[column](validationConfig[column]));
            }
        }
        return validations;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1mb3JtLWJ1aWxkZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Acnh3ZWIvcmVhY3RpdmUtZHluYW1pYy1mb3Jtcy8iLCJzb3VyY2VzIjpbInNlcnZpY2VzL2R5bmFtaWMtZm9ybS1idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxlQUFlLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUUzRyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFFakUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzNELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRTdELE1BQU0sS0FBSyxHQUFXLE9BQU8sQ0FBQztBQUM5QixNQUFNLE9BQU8sb0JBQW9CO0lBRTdCLFNBQVMsQ0FBQyxNQUFhLEVBQUUsaUJBQTRDO1FBQ2pFLElBQUksY0FBYyxHQUFHLGlCQUFpQixDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3hELGlCQUFpQixDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDckQsSUFBSSxDQUFDLGlCQUFpQixHQUFHLGlCQUFpQixJQUFJLEVBQUUsQ0FBQztRQUNqRCxJQUFJLFlBQVksR0FBMkIsRUFBRSxDQUFDO1FBQzlDLElBQUksZ0JBQWdCLEdBQUcsSUFBSSxLQUFLLEVBQXFCLENBQUM7UUFDdEQsSUFBSSxXQUFXLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLElBQUksU0FBUyxHQUFHLElBQUksV0FBVyxDQUFDLEVBQUUsRUFBRSxZQUFZLEVBQUUsRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ2pFLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFD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LEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQztRQUNuQyxJQUFJLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDcEIsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO1FBQzdCLFlBQVksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQztRQUMvQixhQUFhLENBQUMsV0FBVyxHQUFHLElBQUksYUFBYSxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsVUFBVSxFQUFFLGVBQWUsRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQztRQUMvSCxPQUFPLGFBQWEsQ0FBQztJQUN6QixDQUFDO0lBRU8saUJBQWlCLENBQUMsV0FBa0IsRUFBRSxnQkFBcUI7UUFDL0QsS0FBSyxJQUFJLE1BQU0sSUFBSSxlQUFlLEVBQUU7WUFDaEMsSUFBSSxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsRUFBRTtnQkFDMUIsV0FBVyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ3ZFO1NBQ0o7UUFDRCxPQUFPLFdBQVcsQ0FBQztJQUN2QixDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBWYWxpZGF0b3JGbiwgQXN5bmNWYWxpZGF0b3JGbiB9IGZyb20gXCJAYW5ndWxhci9mb3Jtc1wiXHJcblxyXG5pbXBvcnQgeyBSeEZvcm1Hcm91cCwgUnhGb3JtQXJyYXksIFJ4Rm9ybUNvbnRyb2wsIFJ4d2ViVmFsaWRhdG9ycyB9IGZyb20gJ0ByeHdlYi9yZWFjdGl2ZS1mb3JtLXZhbGlkYXRvcnMnO1xyXG5pbXBvcnQgeyBEeW5hbWljRm9ybUNvbmZpZ3VyYXRpb24gfSBmcm9tIFwiLi4vbW9kZWxzL2ludGVyZmFjZVwiO1xyXG5pbXBvcnQgeyBGb3JtQ29udHJvbENvbmZpZyB9IGZyb20gXCIuL2Zvcm0tY29udHJvbC1jb25maWdcIjtcclxuaW1wb3J0IHsgZ2V0SW5zdGFuY2UgfSBmcm9tIFwiLi4vZnVuY3Rpb25zL2dldC1pbnN0YW5jZS5mdW5jdGlvblwiO1xyXG5pbXBvcnQgeyBEeW5hbWljRm9ybUJ1aWxkQ29uZmlnIH0gZnJvbSAnLi4vbW9kZWxzL2ludGVyZmFjZS9keW5hbWljLWZvcm0tYnVpbGQtY29uZmlnJ1xyXG5pbXBvcnQgeyBBcHBsaWNhdGlvblV0aWwgfSBmcm9tIFwiLi4vdXRpbC9hcHBsaWNhdGlvbi11dGlsXCI7XHJcbmltcG9ydCB7IE5vdGlmaWNhdGlvblN0YXRlIH0gZnJvbSBcIi4uL3N0YXRpY3MvY29udHJvbC1zdGF0ZVwiO1xyXG5cclxuY29uc3QgQVJSQVk6IHN0cmluZyA9IFwiYXJyYXlcIjtcclxuZXhwb3J0IGNsYXNzIFJ4RHluYW1pY0Zvcm1CdWlsZGVyIHtcclxuICAgIHByaXZhdGUgZm9ybUNvbmZpZ3VyYXRpb246IER5bmFtaWNGb3JtQ29uZmlndXJhdGlvbjtcclxuICAgIGZvcm1Hcm91cChmaWVsZHM6IGFueVtdLCBkeW5hbWljRm9ybUNvbmZpZz86IER5bmFtaWNGb3JtQ29uZmlndXJhdGlvbik6IER5bmFtaWNGb3JtQnVpbGRDb25maWcge1xyXG4gICAgICAgIGxldCBub3RpZmljYXRpb25JZCA9IE5vdGlmaWNhdGlvblN0YXRlLm5vdGlmaWNhdGlvbklkKys7XHJcbiAgICAgICAgTm90aWZpY2F0aW9uU3RhdGUubm90aWZpY2F0aW9uc1tub3RpZmljYXRpb25JZF0gPSB7fTtcclxuICAgICAgICB0aGlzLmZvcm1Db25maWd1cmF0aW9uID0gZHluYW1pY0Zvcm1Db25maWcgfHwge307XHJcbiAgICAgICAgbGV0IGVudGl0eU9iamVjdDogeyBba2V5OiBzdHJpbmddOiBhbnkgfSA9IHt9O1xyXG4gICAgICAgIGxldCBmb3JtRmllbGRDb25maWdzID0gbmV3IEFycmF5PEZvcm1Db250cm9sQ29uZmlnPigpO1xyXG4gICAgICAgIGxldCBtb2RlbENvbmZpZyA9IHt9O1xyXG4gICAgICAgIGxldCBmb3JtR3JvdXAgPSBuZXcgUnhGb3JtR3JvdXAoe30sIGVudGl0eU9iamVjdCwge30sIHVuZGVmaW5lZCk7XHJcbiAgICAgICAgZmllbGRzLmZvckVhY2goKHgsIGkpID0+IHtcclxuICAgICAgICAgICAgaWYgKHgudHlwZSA9PSBBUlJBWSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVGb3JtQXJyYXkobW9kZWxDb25maWcsIHgsIEFwcGxpY2F0aW9uVXRpbC5nZXRSb290Rm9ybUdyb3VwKGZvcm1Hcm91cCkgYXMgUnhGb3JtR3JvdXAsIGVudGl0eU9iamVjdCwgbm90aWZpY2F0aW9uSWQpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbGV0IHNwbGl0TmFtZSA9IHgubmFtZS5zcGxpdCgnLicpO1xyXG4gICAgICAgICAgICAgICAgbGV0IG5hbWUgPSB4Lm5hbWU7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3BsaXROYW1lLmxlbmd0aCA+IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWVudGl0eU9iamVjdFtzcGxpdE5hbWVbMF1dKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eU9iamVjdFtzcGxpdE5hbWVbMF1dID0ge307XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1Hcm91cC5hZGRDb250cm9sKHNwbGl0TmFtZVswXSwgbmV3IFJ4Rm9ybUdyb3VwKHt9LCBlbnRpdHlPYmplY3Rbc3BsaXROYW1lWzBdXSwge30sIHVuZGVmaW5lZCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3JtR3JvdXAgPSBmb3JtR3JvdXAuY29udHJvbHNbc3BsaXROYW1lWzBdXSBhcyBSeEZvcm1Hcm91cDtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGZvcm1Hcm91cC5jb250cm9sc1tzcGxpdE5hbWVbMF1dICE9IHVuZGVmaW5lZCAmJiBmb3JtR3JvdXAuY29udHJvbHNbc3BsaXROYW1lWzBdXSBpbnN0YW5jZW9mIFJ4Rm9ybUdyb3VwKSBcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9ybUdyb3VwID0gZm9ybUdyb3VwLmNvbnRyb2xzW3NwbGl0TmFtZVswXV0gYXMgUnhGb3JtR3JvdXA7XHJcbiAgICAgICAgICAgICAgICAgICAgbmFtZSA9IHNwbGl0TmFtZVsxXTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZVxyXG4gICAgICAgICAgICAgICAgICAgIGZvcm1Hcm91cCA9IEFwcGxpY2F0aW9uVXRpbC5nZXRSb290Rm9ybUdyb3VwKGZvcm1Hcm91cCkgYXMgUnhGb3JtR3JvdXA7XHJcbiAgICAgICAgICAgICAgICBsZXQgbW9kZWxJbnN0YW5jZSA9IHRoaXMuZ2V0RHluYW1pY01vZGVsSW5zdGFuY2UoeCwgbW9kZWxDb25maWcsIGVudGl0eU9iamVjdCwgbmFtZSwgbm90aWZpY2F0aW9uSWQpO1xyXG4gICAgICAgICAgICAgICAgZm9ybUdyb3VwLmFkZENvbnRyb2wobmFtZSwgbW9kZWxJbnN0YW5jZS5mb3JtQ29udHJvbCk7XHJcbiAgICAgICAgICAgICAgICBmb3JtRmllbGRDb25maWdzLnB1c2gobW9kZWxJbnN0YW5jZSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGlmICh0aGlzLmZvcm1Db25maWd1cmF0aW9uLmFkZGl0aW9uYWxDb25maWcpXHJcbiAgICAgICAgICAgIHRoaXMuZm9ybUNvbmZpZ3VyYXRpb24uYWRkaXRpb25hbENvbmZpZy5mb3JFYWNoKHQgPT4gdGhpcy5nZXRNb2RlbEluc3RhbmNlKHQsIG1vZGVsQ29uZmlnLCBub3RpZmljYXRpb25JZCkpO1xyXG4gICAgICAgIGxldCByb290Rm9ybUdyb3VwID0gQXBwbGljYXRpb25VdGlsLmdldFJvb3RGb3JtR3JvdXAoZm9ybUdyb3VwKSBhcyBSeEZvcm1Hcm91cDtcclxuICAgICAgICByb290Rm9ybUdyb3VwW1wibW9kZWxcIl0gPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgcmV0dXJuICB7XHJcbiAgICAgICAgICAgIGNvbnRyb2xzQ29uZmlnOiBtb2RlbENvbmZpZyxcclxuICAgICAgICAgICAgZm9ybUdyb3VwOiByb290Rm9ybUdyb3VwXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgXHJcblxyXG4gICAgcHJpdmF0ZSBjcmVhdGVGb3JtQXJyYXkobW9kZWxDb25maWc6IGFueSwgZmllbGQ6IHsgW2tleTogc3RyaW5nXTogYW55IH0sIGZvcm1Hcm91cDogUnhGb3JtR3JvdXAsIGVudGl0eU9iamVjdDogeyBba2V5OiBzdHJpbmddOiBhbnkgfSwgbm90aWZpY2F0aW9uSWQpIHtcclxuICAgICAgICBtb2RlbENvbmZpZ1tmaWVsZC5uYW1lXSA9IFtdO1xyXG4gICAgICAgIGVudGl0eU9iamVjdFtmaWVsZC5uYW1lXSA9IFtdO1xyXG4gICAgICAgIGxldCBmb3JtQXJyYXkgPSBuZXcgUnhGb3JtQXJyYXkoZW50aXR5T2JqZWN0W2ZpZWxkLm5hbWVdLCBbXSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKGZpZWxkLmNvbnRyb2xDb25maWdzKSB7XHJcbiAgICAgICAgICAgIGlmIChmaWVsZC5yb3dzKVxyXG4gICAgICAgICAgICBmaWVsZC5yb3dzLmZvckVhY2gocm93ID0+IHtcclxuICAgICAgICAgICAgICAgIGZvcm1BcnJheS5jb250cm9scy5wdXNoKHRoaXMuY3JlYXRlRHluYW1pY0Zvcm1Hcm91cChmaWVsZCwgbW9kZWxDb25maWdbZmllbGQubmFtZV0sIHRoaXMuZ2V0UmVmT2JqZWN0KGVudGl0eU9iamVjdFtmaWVsZC5uYW1lXSksIHJvdywgbm90aWZpY2F0aW9uSWQpKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgaWYgKGZpZWxkLm1pbmltdW1SZXBlYXRDb3VudCAmJiBmaWVsZC5taW5pbXVtUmVwZWF0Q291bnQgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgY291bnRMZWZ0ID0gZmllbGQubWluaW11bVJlcGVhdENvdW50IC0gKGZvcm1BcnJheS5jb250cm9scy5sZW5ndGgpXHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvdW50TGVmdDsgaSsrKVxyXG4gICAgICAgICAgICAgICAgICAgIGZvcm1BcnJheS5jb250cm9scy5wdXNoKHRoaXMuY3JlYXRlRHluYW1pY0Zvcm1Hcm91cChmaWVsZCwgbW9kZWxDb25maWdbZmllbGQubmFtZV0sIHRoaXMuZ2V0UmVmT2JqZWN0KGVudGl0eU9iamVjdFtmaWVsZC5uYW1lXSksIHsgZmllbGRzOiBbXSB9LCBub3RpZmljYXRpb25JZCkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuYWRkVHdvUHJvcChtb2RlbENvbmZpZ1tmaWVsZC5uYW1lXSwgZmllbGQsIGVudGl0eU9iamVjdFtmaWVsZC5uYW1lXSwgZm9ybUFycmF5LG5vdGlmaWNhdGlvbklkKTtcclxuICAgICAgICAgICAgZm9ybUdyb3VwLmFkZENvbnRyb2woZmllbGQubmFtZSwgZm9ybUFycmF5KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRSZWZPYmplY3QoZW50aXR5T2JqZWN0OmFueVtdKSB7XHJcbiAgICAgICAgbGV0IGpPYmplY3QgPSB7fTtcclxuICAgICAgICBlbnRpdHlPYmplY3QucHVzaChqT2JqZWN0KTtcclxuICAgICAgICByZXR1cm4gak9iamVjdDtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBhZGRUd29Qcm9wKG1vZGVsQ29uZmlnOiBhbnksIHgsIGVudGl0eU9iamVjdCwgZm9ybUFycmF5LG5vdGlmaWNhdGlvbklkKSB7XHJcbiAgICAgICAgbW9kZWxDb25maWcuX19wcm90b19fLmFkZEl0ZW0gPSAoKSA9PiB7XHJcbiAgICAgICAgICAgIGZvcm1BcnJheS5jb250cm9scy5wdXNoKHRoaXMuY3JlYXRlRHluYW1pY0Zvcm1Hcm91cCh4LCBtb2RlbENvbmZpZywgdGhpcy5nZXRSZWZPYmplY3QoZW50aXR5T2JqZWN0KSwgeyBmaWVsZHM6IFtdIH0sIG5vdGlmaWNhdGlvbklkKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBtb2RlbENvbmZpZy5fX3Byb3RvX18ucmVtb3ZlSXRlbSA9IChpbmRleDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgICAgIGZvcm1BcnJheS5yZW1vdmVBdChpbmRleCk7XHJcbiAgICAgICAgICAgIG1vZGVsQ29uZmlnLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY3JlYXRlRHluYW1pY0Zvcm1Hcm91cCh4LCBtb2RlbENvbmZpZywgZW50aXR5T2JqZWN0LCByb3csIG5vdGlmaWNhdGlvbklkKSB7XHJcbiAgICAgICAgbGV0IG5lc3RlZEZvcm1Hcm91cCA9IG5ldyBSeEZvcm1Hcm91cCh7fSwgZW50aXR5T2JqZWN0LCB7fSwgdW5kZWZpbmVkKTtcclxuICAgICAgICBsZXQgak9iamVjdCA9IHt9O1xyXG4gICAgICAgIG1vZGVsQ29uZmlnLnB1c2goak9iamVjdCk7XHJcbiAgICAgICAgT2JqZWN0LmtleXMoeC5jb250cm9sQ29uZmlncykuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgZmllbGQgPSByb3cuZmllbGRzLmZpbHRlcih4ID0+IHgubmFtZSA9PSBrZXkpWzBdO1xyXG4gICAgICAgICAgICBsZXQgZm9ybUNvbnRyb2xDb25maWcgPSB7IC4uLnguY29udHJvbENvbmZpZ3Nba2V5XSwgLi4ueyBuYW1lOiBrZXkgfSB9O1xyXG4gICAgICAgICAgICBpZiAoZmllbGQpXHJcbiAgICAgICAgICAgICAgICBmb3JtQ29udHJvbENvbmZpZyA9IHsgLi4uZm9ybUNvbnRyb2xDb25maWcsIC4uLmZpZWxkIH07XHJcbiAgICAgICAgICAgIGxldCBtb2RlbEluc3RhbmNlID0gdGhpcy5nZXREeW5hbWljTW9kZWxJbnN0YW5jZShmb3JtQ29udHJvbENvbmZpZywgak9iamVjdCwgZW50aXR5T2JqZWN0LCBrZXksIG5vdGlmaWNhdGlvbklkKTtcclxuICAgICAgICAgICAgbmVzdGVkRm9ybUdyb3VwLmFkZENvbnRyb2woa2V5LCBtb2RlbEluc3RhbmNlLmZvcm1Db250cm9sKTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIHJldHVybiBuZXN0ZWRGb3JtR3JvdXA7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRNb2RlbEluc3RhbmNlKHgsIG1vZGVsQ29uZmlnLCBub3RpZmljYXRpb25JZCkge1xyXG4gICAgICAgIGxldCBjb25maWdNb2RlbCA9ICh4Lm1vZGVsTmFtZSkgJiYgdGhpcy5mb3JtQ29uZmlndXJhdGlvbiAmJiB0aGlzLmZvcm1Db25maWd1cmF0aW9uLmNvbnRyb2xDb25maWdNb2RlbHMgPyB0aGlzLmZvcm1Db25maWd1cmF0aW9uLmNvbnRyb2xDb25maWdNb2RlbHMuZmlsdGVyKCh5KSA9PiB5Lm1vZGVsTmFtZSA9PSB4Lm1vZGVsTmFtZSlbMF0gOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgbGV0IG1vZGVsQXJndW1lbnRzID0gW3gsIG1vZGVsQ29uZmlnLCBub3RpZmljYXRpb25JZF07XHJcbiAgICAgICAgbGV0IG1vZGVsID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIGlmIChjb25maWdNb2RlbCkge1xyXG4gICAgICAgICAgICBtb2RlbCA9IGNvbmZpZ01vZGVsLm1vZGVsO1xyXG4gICAgICAgICAgICBpZiAoY29uZmlnTW9kZWwuYXJndW1lbnRzKVxyXG4gICAgICAgICAgICAgICAgY29uZmlnTW9kZWwuYXJndW1lbnRzLmZvckVhY2godCA9PiBtb2RlbEFyZ3VtZW50cy5wdXNoKHQpKTtcclxuICAgICAgICB9IGVsc2VcclxuICAgICAgICAgICAgbW9kZWwgPSBGb3JtQ29udHJvbENvbmZpZztcclxuICAgICAgICBsZXQgbW9kZWxJbnN0YW5jZSA9IGdldEluc3RhbmNlKG1vZGVsLCBtb2RlbEFyZ3VtZW50cyk7XHJcbiAgICAgICAgbW9kZWxDb25maWdbeC5uYW1lXSA9IG1vZGVsSW5zdGFuY2U7XHJcbiAgICAgICAgcmV0dXJuIG1vZGVsSW5zdGFuY2VcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldER5bmFtaWNNb2RlbEluc3RhbmNlKHgsIG1vZGVsQ29uZmlnLCBlbnRpdHlPYmplY3QsIG5hbWUsIG5vdGlmaWNhdGlvbklkKSB7XHJcbiAgICAgICAgbGV0IG1vZGVsSW5zdGFuY2UgPSB0aGlzLmdldE1vZGVsSW5zdGFuY2UoeCwgbW9kZWxDb25maWcsIG5vdGlmaWNhdGlvbklkKTtcclxuICAgICAgICBsZXQgdmFsaWRhdG9yczogVmFsaWRhdG9yRm5bXSA9IFtdO1xyXG4gICAgICAgIGxldCBhc3luY1ZhbGlkYXRvcnM6IEFzeW5jVmFsaWRhdG9yRm5bXSA9IFtdO1xyXG4gICAgICAgIGlmICh4LnZhbGlkYXRvcnMpXHJcbiAgICAgICAgICAgIHRoaXMudmFsaWRhdG9yQmluZGluZ3ModmFsaWRhdG9ycywgeC52YWxpZGF0b3JzKTtcclxuICAgICAgICBpZiAobW9kZWxJbnN0YW5jZS52YWxpZGF0b3IpXHJcbiAgICAgICAgICAgIHZhbGlkYXRvcnMucHVzaChtb2RlbEluc3RhbmNlLnZhbGlkYXRvci5iaW5kKG1vZGVsSW5zdGFuY2UpKTtcclxuICAgICAgICBpZiAobW9kZWxJbnN0YW5jZS5hc3luY1ZhbGlkYXRvcilcclxuICAgICAgICAgICAgYXN5bmNWYWxpZGF0b3JzLnB1c2gobW9kZWxJbnN0YW5jZS5hc3luY1ZhbGlkYXRvci5iaW5kKG1vZGVsSW5zdGFuY2UpKTtcclxuICAgICAgICBpZiAobW9kZWxJbnN0YW5jZSlcclxuICAgICAgICAgICAgZW50aXR5T2JqZWN0W3gubmFtZV0gPSB4LnZhbHVlO1xyXG4gICAgICAgIGxldCBiYXNlT2JqZWN0ID0ge307XHJcbiAgICAgICAgYmFzZU9iamVjdFt4Lm5hbWVdID0geC52YWx1ZTtcclxuICAgICAgICBlbnRpdHlPYmplY3RbeC5uYW1lXSA9IHgudmFsdWU7XHJcbiAgICAgICAgbW9kZWxJbnN0YW5jZS5mb3JtQ29udHJvbCA9IG5ldyBSeEZvcm1Db250cm9sKHgudmFsdWUsIHZhbGlkYXRvcnMsIGFzeW5jVmFsaWRhdG9ycywgZW50aXR5T2JqZWN0LCBiYXNlT2JqZWN0LCBuYW1lLCB1bmRlZmluZWQpO1xyXG4gICAgICAgIHJldHVybiBtb2RlbEluc3RhbmNlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdmFsaWRhdG9yQmluZGluZ3ModmFsaWRhdGlvbnM6IGFueVtdLCB2YWxpZGF0aW9uQ29uZmlnOiBhbnkpIHtcclxuICAgICAgICBmb3IgKHZhciBjb2x1bW4gaW4gUnh3ZWJWYWxpZGF0b3JzKSB7XHJcbiAgICAgICAgICAgIGlmICh2YWxpZGF0aW9uQ29uZmlnW2NvbHVtbl0pIHtcclxuICAgICAgICAgICAgICAgIHZhbGlkYXRpb25zLnB1c2goUnh3ZWJWYWxpZGF0b3JzW2NvbHVtbl0odmFsaWRhdGlvbkNvbmZpZ1tjb2x1bW5dKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHZhbGlkYXRpb25zO1xyXG4gICAgfVxyXG59Il19