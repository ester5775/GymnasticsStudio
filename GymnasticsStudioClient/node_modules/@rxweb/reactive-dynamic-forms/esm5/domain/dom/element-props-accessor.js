import * as tslib_1 from "tslib";
import { ElementEventProcessor } from './element-event-processor';
import { ADDITIONAL_CLASS, BOOLEAN, NONE, BLANK, DISPLAY, FUNCTION, STRING, ATTR, PROP, CLASS, STYLE } from '../../const/app.const';
var ElementPropsAccessor = /** @class */ (function (_super) {
    tslib_1.__extends(ElementPropsAccessor, _super);
    function ElementPropsAccessor(dynamicNodeConfig) {
        var _this = _super.call(this, dynamicNodeConfig) || this;
        _this.oldAdditionalClasses = [];
        _this.oldClasses = [];
        return _this;
    }
    ElementPropsAccessor.prototype.bindAttribute = function (attr, isSubscribe) {
        var _this = this;
        Object.keys(attr).forEach(function (attributeName) {
            var value = (attributeName !== STYLE) ? _this.getValue(attr[attributeName]) : attr[attributeName];
            switch (attributeName) {
                case ADDITIONAL_CLASS:
                case CLASS:
                    _this.setClass(value, attributeName);
                    break;
                case STYLE:
                    Object.keys(attr[attributeName]).forEach(function (x) {
                        var value = _this.getValue(attr[attributeName][x]);
                        _this.setStyleProp(x, value);
                        if (isSubscribe && _this.isSubscribeProp(attr[attributeName][x]))
                            _this.setPropSubscription(attr[attributeName][x], ATTR, x, '', STYLE);
                    });
                    break;
                default:
                    _this.addOrRemoveAttribute(attributeName, value, attr[attributeName] === "");
                    break;
            }
            if (isSubscribe && attributeName !== STYLE && _this.isSubscribeProp(attr[attributeName]))
                _this.setPropSubscription(attr[attributeName], ATTR, attributeName);
        });
    };
    ElementPropsAccessor.prototype.bindProp = function (prop, isSubscribe) {
        var _this = this;
        Object.keys(prop).forEach(function (propName) {
            var value = _this.getValue(prop[propName]);
            _this.setProperty(propName, (value !== undefined && value !== null && value !== false) ? value : "");
            if (isSubscribe && _this.isSubscribeProp(prop[propName]))
                _this.setPropSubscription(prop[propName], PROP, propName);
        });
    };
    ElementPropsAccessor.prototype.setClass = function (classes, type) {
        classes = this.getClassNames(type == ADDITIONAL_CLASS ? this.dynamicNodeConfig.additionalClasses.class : classes);
        type == ADDITIONAL_CLASS ? this.addOrRemoveClasses(this.oldAdditionalClasses, false) : this.addOrRemoveClasses(this.oldClasses, false);
        this.addOrRemoveClasses(classes);
        switch (type) {
            case ADDITIONAL_CLASS:
                this.oldAdditionalClasses = classes;
                break;
            case CLASS:
                this.oldClasses = classes;
                break;
        }
    };
    ElementPropsAccessor.prototype.setStyleProp = function (propName, value) {
        switch (propName) {
            case DISPLAY:
                value = (typeof value == BOOLEAN || value === undefined) ? value : !(value);
                value = (value) ? NONE : BLANK;
                break;
        }
        this.addOrRemoveStyle(propName, value);
    };
    ElementPropsAccessor.prototype.setProperty = function (propertyName, value) {
        this.dynamicNodeConfig.renderer.setProperty(this.element, propertyName, value);
    };
    ElementPropsAccessor.prototype.addOrRemoveClasses = function (classes, isAdd) {
        var _this = this;
        if (isAdd === void 0) { isAdd = true; }
        if (isAdd)
            classes.forEach(function (t) { return _this.dynamicNodeConfig.renderer.addClass(_this.element, t); });
        else
            classes.forEach(function (t) { return _this.dynamicNodeConfig.renderer.removeClass(_this.element, t); });
    };
    ElementPropsAccessor.prototype.addOrRemoveStyle = function (styleName, value) {
        if (value)
            this.dynamicNodeConfig.renderer.setStyle(this.element, styleName, value);
        else
            this.dynamicNodeConfig.renderer.removeStyle(this.element, styleName);
    };
    ElementPropsAccessor.prototype.addOrRemoveAttribute = function (attributeName, value, isBlank) {
        if (value || isBlank)
            this.dynamicNodeConfig.renderer.setAttribute(this.element, attributeName, value);
        else
            this.dynamicNodeConfig.renderer.removeAttribute(this.element, attributeName);
    };
    ElementPropsAccessor.prototype.getClassNames = function (classes) {
        var _this = this;
        var elementClasses = [];
        if (classes)
            classes.forEach(function (t) {
                if (typeof t == STRING)
                    elementClasses.push(t);
                else if (typeof t == FUNCTION) {
                    var elementClass = t.call(_this.controlConfig);
                    if (elementClass && !Array.isArray(elementClass))
                        elementClasses.push(elementClass);
                    else if (Array.isArray(elementClass))
                        elementClass.forEach(function (x) { return elementClasses.push(x); });
                }
            });
        return elementClasses;
    };
    return ElementPropsAccessor;
}(ElementEventProcessor));
export { ElementPropsAccessor };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWxlbWVudC1wcm9wcy1hY2Nlc3Nvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0ByeHdlYi9yZWFjdGl2ZS1keW5hbWljLWZvcm1zLyIsInNvdXJjZXMiOlsiZG9tYWluL2RvbS9lbGVtZW50LXByb3BzLWFjY2Vzc29yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUVsRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFcEk7SUFBbUQsZ0RBQXFCO0lBR3BFLDhCQUFZLGlCQUFvQztRQUFoRCxZQUFvRCxrQkFBTSxpQkFBaUIsQ0FBQyxTQUFHO1FBRnZFLDBCQUFvQixHQUFhLEVBQUUsQ0FBQztRQUNwQyxnQkFBVSxHQUFhLEVBQUUsQ0FBQzs7SUFDNEMsQ0FBQztJQUcvRSw0Q0FBYSxHQUFiLFVBQWMsSUFBNEIsRUFBRSxXQUFvQjtRQUFoRSxpQkF3QkM7UUF2QkcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQSxhQUFhO1lBQ25DLElBQUksS0FBSyxHQUFHLENBQUMsYUFBYSxLQUFLLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDakcsUUFBUSxhQUFhLEVBQUU7Z0JBQ25CLEtBQUssZ0JBQWdCLENBQUM7Z0JBQ3RCLEtBQUssS0FBSztvQkFDTixLQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxhQUFhLENBQUMsQ0FBQztvQkFDcEMsTUFBTTtnQkFDVixLQUFLLEtB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QUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUM7d0JBQ2hDLFlBQVksQ0FBQyxPQUFPLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUF0QixDQUFzQixDQUFDLENBQUE7aUJBQ3hEO1lBQ0wsQ0FBQyxDQUFDLENBQUE7UUFDTixPQUFPLGNBQWMsQ0FBQztJQUMxQixDQUFDO0lBQ0wsMkJBQUM7QUFBRCxDQUFDLEFBNUdELENBQW1ELHFCQUFxQixHQTRHdkUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFbGVtZW50RXZlbnRQcm9jZXNzb3IgfSBmcm9tICcuL2VsZW1lbnQtZXZlbnQtcHJvY2Vzc29yJztcclxuaW1wb3J0IHsgRHluYW1pY05vZGVDb25maWcgfSBmcm9tICcuLi8uLi9tb2RlbHMvaW50ZXJmYWNlL2R5bmFtaWMtbm9kZS1jb25maWcnO1xyXG5pbXBvcnQgeyBBRERJVElPTkFMX0NMQVNTLCBCT09MRUFOLCBOT05FLCBCTEFOSywgRElTUExBWSwgRlVOQ1RJT04sIFNUUklORywgQVRUUiwgUFJPUCwgQ0xBU1MsIFNUWUxFIH0gZnJvbSAnLi4vLi4vY29uc3QvYXBwLmNvbnN0JztcclxuXHJcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBFbGVtZW50UHJvcHNBY2Nlc3NvciBleHRlbmRzIEVsZW1lbnRFdmVudFByb2Nlc3NvciB7XHJcbiAgICBwcml2YXRlIG9sZEFkZGl0aW9uYWxDbGFzc2VzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgcHJpdmF0ZSBvbGRDbGFzc2VzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgY29uc3RydWN0b3IoZHluYW1pY05vZGVDb25maWc6IER5bmFtaWNOb2RlQ29uZmlnKSB7IHN1cGVyKGR5bmFtaWNOb2RlQ29uZmlnKTsgfVxyXG5cclxuXHJcbiAgICBiaW5kQXR0cmlidXRlKGF0dHI6IHsgW2tleTogc3RyaW5nXTogYW55IH0sIGlzU3Vic2NyaWJlOiBib29sZWFuKSB7XHJcbiAgICAgICAgT2JqZWN0LmtleXMoYXR0cikuZm9yRWFjaChhdHRyaWJ1dGVOYW1lID0+IHtcclxuICAgICAgICAgICAgbGV0IHZhbHVlID0gKGF0dHJpYnV0ZU5hbWUgIT09IFNUWUxFKSA/IHRoaXMuZ2V0VmFsdWUoYXR0clthdHRyaWJ1dGVOYW1lXSkgOiBhdHRyW2F0dHJpYnV0ZU5hbWVdO1xyXG4gICAgICAgICAgICBzd2l0Y2ggKGF0dHJpYnV0ZU5hbWUpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgQURESVRJT05BTF9DTEFTUzpcclxuICAgICAgICAgICAgICAgIGNhc2UgQ0xBU1M6XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRDbGFzcyh2YWx1ZSwgYXR0cmlidXRlTmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFNUWUxFOlxyXG4gICAgICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKGF0dHJbYXR0cmlidXRlTmFtZV0pLmZvckVhY2goeCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuZ2V0VmFsdWUoYXR0clthdHRyaWJ1dGVOYW1lXVt4XSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3R5bGVQcm9wKHgsIHZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzU3Vic2NyaWJlICYmIHRoaXMuaXNTdWJzY3JpYmVQcm9wKGF0dHJbYXR0cmlidXRlTmFtZV1beF0pKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRQcm9wU3Vic2NyaXB0aW9uKGF0dHJbYXR0cmlidXRlTmFtZV1beF0sIEFUVFIsIHgsICcnLCBTVFlMRSlcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZE9yUmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUsIHZhbHVlLCBhdHRyW2F0dHJpYnV0ZU5hbWVdID09PSBcIlwiKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoaXNTdWJzY3JpYmUgJiYgYXR0cmlidXRlTmFtZSAhPT0gU1RZTEUgJiYgdGhpcy5pc1N1YnNjcmliZVByb3AoYXR0clthdHRyaWJ1dGVOYW1lXSkpXHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldFByb3BTdWJzY3JpcHRpb24oYXR0clthdHRyaWJ1dGVOYW1lXSwgQVRUUiwgYXR0cmlidXRlTmFtZSk7XHJcbiAgICAgICAgfSlcclxuXHJcbiAgICB9XHJcblxyXG4gICAgYmluZFByb3AocHJvcDogeyBba2V5OiBzdHJpbmddOiBhbnkgfSwgaXNTdWJzY3JpYmU6IGJvb2xlYW4pIHtcclxuICAgICAgICBPYmplY3Qua2V5cyhwcm9wKS5mb3JFYWNoKHByb3BOYW1lID0+IHtcclxuICAgICAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5nZXRWYWx1ZShwcm9wW3Byb3BOYW1lXSk7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0UHJvcGVydHkocHJvcE5hbWUsICh2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlICE9PSBudWxsICYmIHZhbHVlICE9PSBmYWxzZSkgPyB2YWx1ZSA6IFwiXCIpXHJcbiAgICAgICAgICAgIGlmIChpc1N1YnNjcmliZSAmJiB0aGlzLmlzU3Vic2NyaWJlUHJvcChwcm9wW3Byb3BOYW1lXSkpXHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldFByb3BTdWJzY3JpcHRpb24ocHJvcFtwcm9wTmFtZV0sIFBST1AsIHByb3BOYW1lKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRDbGFzcyhjbGFzc2VzOiBhbnlbXSwgdHlwZTogc3RyaW5nKSB7XHJcbiAgICAgICAgY2xhc3NlcyA9IHRoaXMuZ2V0Q2xhc3NOYW1lcyh0eXBlID09IEFERElUSU9OQUxfQ0xBU1MgPyB0aGlzLmR5bmFtaWNOb2RlQ29uZmlnLmFkZGl0aW9uYWxDbGFzc2VzLmNsYXNzIDogY2xhc3Nlcyk7XHJcbiAgICAgICAgdHlwZSA9PSBBRERJVElPTkFMX0NMQVNTID8gdGhpcy5hZGRPclJlbW92ZUNsYXNzZXModGhpcy5vbGRBZGRpdGlvbmFsQ2xhc3NlcywgZmFsc2UpIDogdGhpcy5hZGRPclJlbW92ZUNsYXNzZXModGhpcy5vbGRDbGFzc2VzLCBmYWxzZSk7XHJcbiAgICAgICAgdGhpcy5hZGRPclJlbW92ZUNsYXNzZXMoY2xhc3Nlcyk7XHJcbiAgICAgICAgc3dpdGNoICh0eXBlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgQURESVRJT05BTF9DTEFTUzpcclxuICAgICAgICAgICAgICAgIHRoaXMub2xkQWRkaXRpb25hbENsYXNzZXMgPSBjbGFzc2VzO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgQ0xBU1M6XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9sZENsYXNzZXMgPSBjbGFzc2VzO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNldFN0eWxlUHJvcChwcm9wTmFtZTogc3RyaW5nLCB2YWx1ZTogYW55KSB7XHJcbiAgICAgICAgc3dpdGNoIChwcm9wTmFtZSkge1xyXG4gICAgICAgICAgICBjYXNlIERJU1BMQVk6XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9ICh0eXBlb2YgdmFsdWUgPT0gQk9PTEVBTiB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSA/IHZhbHVlIDogISh2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9ICh2YWx1ZSkgPyBOT05FIDogQkxBTks7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5hZGRPclJlbW92ZVN0eWxlKHByb3BOYW1lLCB2YWx1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0UHJvcGVydHkocHJvcGVydHlOYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcclxuICAgICAgICB0aGlzLmR5bmFtaWNOb2RlQ29uZmlnLnJlbmRlcmVyLnNldFByb3BlcnR5KHRoaXMuZWxlbWVudCwgcHJvcGVydHlOYW1lLCB2YWx1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgYWRkT3JSZW1vdmVDbGFzc2VzKGNsYXNzZXM6IGFueVtdLCBpc0FkZDogYm9vbGVhbiA9IHRydWUpIHtcclxuXHJcbiAgICAgICAgaWYgKGlzQWRkKVxyXG4gICAgICAgICAgICBjbGFzc2VzLmZvckVhY2godCA9PiB0aGlzLmR5bmFtaWNOb2RlQ29uZmlnLnJlbmRlcmVyLmFkZENsYXNzKHRoaXMuZWxlbWVudCwgdCkpO1xyXG4gICAgICAgIGVsc2VcclxuICAgICAgICAgICAgY2xhc3Nlcy5mb3JFYWNoKHQgPT4gdGhpcy5keW5hbWljTm9kZUNvbmZpZy5yZW5kZXJlci5yZW1vdmVDbGFzcyh0aGlzLmVsZW1lbnQsIHQpKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgYWRkT3JSZW1vdmVTdHlsZShzdHlsZU5hbWU6IHN0cmluZywgdmFsdWU6IGFueSkge1xyXG4gICAgICAgIGlmICh2YWx1ZSlcclxuICAgICAgICAgICAgdGhpcy5keW5hbWljTm9kZUNvbmZpZy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLmVsZW1lbnQsIHN0eWxlTmFtZSwgdmFsdWUpO1xyXG4gICAgICAgIGVsc2VcclxuICAgICAgICAgICAgdGhpcy5keW5hbWljTm9kZUNvbmZpZy5yZW5kZXJlci5yZW1vdmVTdHlsZSh0aGlzLmVsZW1lbnQsIHN0eWxlTmFtZSk7XHJcbiAgICB9XHJcblxyXG4gICAgYWRkT3JSZW1vdmVBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZTogc3RyaW5nLCB2YWx1ZTogYW55LGlzQmxhbms6Ym9vbGVhbikge1xyXG4gICAgICAgIGlmICh2YWx1ZSB8fCBpc0JsYW5rKVxyXG4gICAgICAgICAgICB0aGlzLmR5bmFtaWNOb2RlQ29uZmlnLnJlbmRlcmVyLnNldEF0dHJpYnV0ZSh0aGlzLmVsZW1lbnQsIGF0dHJpYnV0ZU5hbWUsIHZhbHVlKTtcclxuICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgIHRoaXMuZHluYW1pY05vZGVDb25maWcucmVuZGVyZXIucmVtb3ZlQXR0cmlidXRlKHRoaXMuZWxlbWVudCwgYXR0cmlidXRlTmFtZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRDbGFzc05hbWVzKGNsYXNzZXM6IGFueVtdKSB7XHJcbiAgICAgICAgbGV0IGVsZW1lbnRDbGFzc2VzID0gW107XHJcbiAgICAgICAgaWYgKGNsYXNzZXMpXHJcbiAgICAgICAgICAgIGNsYXNzZXMuZm9yRWFjaCh0ID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdCA9PSBTVFJJTkcpXHJcbiAgICAgICAgICAgICAgICAgICAgZWxlbWVudENsYXNzZXMucHVzaCh0KTtcclxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHR5cGVvZiB0ID09IEZVTkNUSU9OKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGVsZW1lbnRDbGFzcyA9IHQuY2FsbCh0aGlzLmNvbnRyb2xDb25maWcpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlbGVtZW50Q2xhc3MgJiYgIUFycmF5LmlzQXJyYXkoZWxlbWVudENsYXNzKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudENsYXNzZXMucHVzaChlbGVtZW50Q2xhc3MpXHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoQXJyYXkuaXNBcnJheShlbGVtZW50Q2xhc3MpKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Q2xhc3MuZm9yRWFjaCh4ID0+IGVsZW1lbnRDbGFzc2VzLnB1c2goeCkpXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgcmV0dXJuIGVsZW1lbnRDbGFzc2VzO1xyXG4gICAgfVxyXG59Il19