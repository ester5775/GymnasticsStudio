import * as tslib_1 from "tslib";
import { RxFormGroup, RxFormArray, RxFormControl, RxwebValidators } from '@rxweb/reactive-form-validators';
import { FormControlConfig } from "./form-control-config";
import { getInstance } from "../functions/get-instance.function";
import { ApplicationUtil } from "../util/application-util";
import { NotificationState } from "../statics/control-state";
var ARRAY = "array";
var RxDynamicFormBuilder = /** @class */ (function () {
    function RxDynamicFormBuilder() {
    }
    RxDynamicFormBuilder.prototype.formGroup = function (fields, dynamicFormConfig) {
        var _this = this;
        var notificationId = NotificationState.notificationId++;
        NotificationState.notifications[notificationId] = {};
        this.formConfiguration = dynamicFormConfig || {};
        var entityObject = {};
        var formFieldConfigs = new Array();
        var modelConfig = {};
        var formGroup = new RxFormGroup({}, entityObject, {}, undefined);
        fields.forEach(function (x, i) {
            if (x.type == ARRAY) {
                _this.createFormArray(modelConfig, x, ApplicationUtil.getRootFormGroup(formGroup), entityObject, notificationId);
            }
            else {
                var splitName = x.name.split('.');
                var name_1 = x.name;
                if (splitName.length > 1) {
                    if (!entityObject[splitName[0]]) {
                        entityObject[splitName[0]] = {};
                        formGroup.addControl(splitName[0], new RxFormGroup({}, entityObject[splitName[0]], {}, undefined));
                        formGroup = formGroup.controls[splitName[0]];
                    }
                    else if (formGroup.controls[splitName[0]] != undefined && formGroup.controls[splitName[0]] instanceof RxFormGroup)
                        formGroup = formGroup.controls[splitName[0]];
                    name_1 = splitName[1];
                }
                else
                    formGroup = ApplicationUtil.getRootFormGroup(formGroup);
                var modelInstance = _this.getDynamicModelInstance(x, modelConfig, entityObject, name_1, notificationId);
                formGroup.addControl(name_1, modelInstance.formControl);
                formFieldConfigs.push(modelInstance);
            }
        });
        if (this.formConfiguration.additionalConfig)
            this.formConfiguration.additionalConfig.forEach(function (t) { return _this.getModelInstance(t, modelConfig, notificationId); });
        var rootFormGroup = ApplicationUtil.getRootFormGroup(formGroup);
        rootFormGroup["model"] = undefined;
        return {
            controlsConfig: modelConfig,
            formGroup: rootFormGroup
        };
    };
    RxDynamicFormBuilder.prototype.createFormArray = function (modelConfig, field, formGroup, entityObject, notificationId) {
        var _this = this;
        modelConfig[field.name] = [];
        entityObject[field.name] = [];
        var formArray = new RxFormArray(entityObject[field.name], []);
        if (field.controlConfigs) {
            if (field.rows)
                field.rows.forEach(function (row) {
                    formArray.controls.push(_this.createDynamicFormGroup(field, modelConfig[field.name], _this.getRefObject(entityObject[field.name]), row, notificationId));
                });
            if (field.minimumRepeatCount && field.minimumRepeatCount > 0) {
                var countLeft = field.minimumRepeatCount - (formArray.controls.length);
                for (var i = 0; i < countLeft; i++)
                    formArray.controls.push(this.createDynamicFormGroup(field, modelConfig[field.name], this.getRefObject(entityObject[field.name]), { fields: [] }, notificationId));
            }
            this.addTwoProp(modelConfig[field.name], field, entityObject[field.name], formArray, notificationId);
            formGroup.addControl(field.name, formArray);
        }
    };
    RxDynamicFormBuilder.prototype.getRefObject = function (entityObject) {
        var jObject = {};
        entityObject.push(jObject);
        return jObject;
    };
    RxDynamicFormBuilder.prototype.addTwoProp = function (modelConfig, x, entityObject, formArray, notificationId) {
        var _this = this;
        modelConfig.__proto__.addItem = function () {
            formArray.controls.push(_this.createDynamicFormGroup(x, modelConfig, _this.getRefObject(entityObject), { fields: [] }, notificationId));
        };
        modelConfig.__proto__.removeItem = function (index) {
            formArray.removeAt(index);
            modelConfig.splice(index, 1);
        };
    };
    RxDynamicFormBuilder.prototype.createDynamicFormGroup = function (x, modelConfig, entityObject, row, notificationId) {
        var _this = this;
        var nestedFormGroup = new RxFormGroup({}, entityObject, {}, undefined);
        var jObject = {};
        modelConfig.push(jObject);
        Object.keys(x.controlConfigs).forEach(function (key) {
            var field = row.fields.filter(function (x) { return x.name == key; })[0];
            var formControlConfig = tslib_1.__assign({}, x.controlConfigs[key], { name: key });
            if (field)
                formControlConfig = tslib_1.__assign({}, formControlConfig, field);
            var modelInstance = _this.getDynamicModelInstance(formControlConfig, jObject, entityObject, key, notificationId);
            nestedFormGroup.addControl(key, modelInstance.formControl);
        });
        return nestedFormGroup;
    };
    RxDynamicFormBuilder.prototype.getModelInstance = function (x, modelConfig, notificationId) {
        var configModel = (x.modelName) && this.formConfiguration && this.formConfiguration.controlConfigModels ? this.formConfiguration.controlConfigModels.filter(function (y) { return y.modelName == x.modelName; })[0] : undefined;
        var modelArguments = [x, modelConfig, notificationId];
        var model = undefined;
        if (configModel) {
            model = configModel.model;
            if (configModel.arguments)
                configModel.arguments.forEach(function (t) { return modelArguments.push(t); });
        }
        else
            model = FormControlConfig;
        var modelInstance = getInstance(model, modelArguments);
        modelConfig[x.name] = modelInstance;
        return modelInstance;
    };
    RxDynamicFormBuilder.prototype.getDynamicModelInstance = function (x, modelConfig, entityObject, name, notificationId) {
        var modelInstance = this.getModelInstance(x, modelConfig, notificationId);
        var validators = [];
        var asyncValidators = [];
        if (x.validators)
            this.validatorBindings(validators, x.validators);
        if (modelInstance.validator)
            validators.push(modelInstance.validator.bind(modelInstance));
        if (modelInstance.asyncValidator)
            asyncValidators.push(modelInstance.asyncValidator.bind(modelInstance));
        if (modelInstance)
            entityObject[x.name] = x.value;
        var baseObject = {};
        baseObject[x.name] = x.value;
        entityObject[x.name] = x.value;
        modelInstance.formControl = new RxFormControl(x.value, validators, asyncValidators, entityObject, baseObject, name, undefined);
        return modelInstance;
    };
    RxDynamicFormBuilder.prototype.validatorBindings = function (validations, validationConfig) {
        for (var column in RxwebValidators) {
            if (validationConfig[column]) {
                validations.push(RxwebValidators[column](validationConfig[column]));
            }
        }
        return validations;
    };
    return RxDynamicFormBuilder;
}());
export { RxDynamicFormBuilder };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1mb3JtLWJ1aWxkZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Acnh3ZWIvcmVhY3RpdmUtZHluYW1pYy1mb3Jtcy8iLCJzb3VyY2VzIjpbInNlcnZpY2VzL2R5bmFtaWMtZm9ybS1idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFFQSxPQUFPLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBRSxhQUFhLEVBQUUsZUFBZSxFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFFM0csT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBRWpFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUU3RCxJQUFNLEtBQUssR0FBVyxPQUFPLENBQUM7QUFDOUI7SUFBQTtJQTJJQSxDQUFDO0lBeklHLHdDQUFTLEdBQVQsVUFBVSxNQUFhLEVBQUUsaUJBQTRDO1FBQXJFLGlCQXFDQztRQXBDRyxJQUFJLGNBQWMsR0FBRyxpQkFBaUIsQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN4RCxpQkFBaUIsQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ3JELElBQUksQ0FBQyxpQkFBaUIsR0FBRyxpQkFBaUIsSUFBSSxFQUFFLENBQUM7UUFDakQsSUFBSSxZQUFZLEdBQTJCLEVBQUUsQ0FBQztRQUM5QyxJQUFJLGdCQUFnQixHQUFHLElBQUksS0FBSyxFQUFxQixDQUFDO1FBQ3RELElBQUksV0FBVyxHQUFHLEVBQUUsQ0FBQztRQUNyQixJQUFJLFNBQVMsR0FBRyxJQUFJLFdBQVcsQ0FBQyxFQUFFLEVBQUUsWUFBWSxFQUFFLEVBQUUsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUNqRSxNQUFNLENBQUMsT0FBTyxDQUFDLFVBQUMsQ0FBQyxFQUFF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YUFBYSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztRQUMzRSxJQUFJLGFBQWE7WUFDYixZQUFZLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUM7UUFDbkMsSUFBSSxVQUFVLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLFVBQVUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQztRQUM3QixZQUFZLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUM7UUFDL0IsYUFBYSxDQUFDLFdBQVcsR0FBRyxJQUFJLGFBQWEsQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLFVBQVUsRUFBRSxlQUFlLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDL0gsT0FBTyxhQUFhLENBQUM7SUFDekIsQ0FBQztJQUVPLGdEQUFpQixHQUF6QixVQUEwQixXQUFrQixFQUFFLGdCQUFxQjtRQUMvRCxLQUFLLElBQUksTUFBTSxJQUFJLGVBQWUsRUFBRTtZQUNoQyxJQUFJLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxFQUFFO2dCQUMxQixXQUFXLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDdkU7U0FDSjtRQUNELE9BQU8sV0FBVyxDQUFDO0lBQ3ZCLENBQUM7SUFDTCwyQkFBQztBQUFELENBQUMsQUEzSUQsSUEySUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBWYWxpZGF0b3JGbiwgQXN5bmNWYWxpZGF0b3JGbiB9IGZyb20gXCJAYW5ndWxhci9mb3Jtc1wiXHJcblxyXG5pbXBvcnQgeyBSeEZvcm1Hcm91cCwgUnhGb3JtQXJyYXksIFJ4Rm9ybUNvbnRyb2wsIFJ4d2ViVmFsaWRhdG9ycyB9IGZyb20gJ0ByeHdlYi9yZWFjdGl2ZS1mb3JtLXZhbGlkYXRvcnMnO1xyXG5pbXBvcnQgeyBEeW5hbWljRm9ybUNvbmZpZ3VyYXRpb24gfSBmcm9tIFwiLi4vbW9kZWxzL2ludGVyZmFjZVwiO1xyXG5pbXBvcnQgeyBGb3JtQ29udHJvbENvbmZpZyB9IGZyb20gXCIuL2Zvcm0tY29udHJvbC1jb25maWdcIjtcclxuaW1wb3J0IHsgZ2V0SW5zdGFuY2UgfSBmcm9tIFwiLi4vZnVuY3Rpb25zL2dldC1pbnN0YW5jZS5mdW5jdGlvblwiO1xyXG5pbXBvcnQgeyBEeW5hbWljRm9ybUJ1aWxkQ29uZmlnIH0gZnJvbSAnLi4vbW9kZWxzL2ludGVyZmFjZS9keW5hbWljLWZvcm0tYnVpbGQtY29uZmlnJ1xyXG5pbXBvcnQgeyBBcHBsaWNhdGlvblV0aWwgfSBmcm9tIFwiLi4vdXRpbC9hcHBsaWNhdGlvbi11dGlsXCI7XHJcbmltcG9ydCB7IE5vdGlmaWNhdGlvblN0YXRlIH0gZnJvbSBcIi4uL3N0YXRpY3MvY29udHJvbC1zdGF0ZVwiO1xyXG5cclxuY29uc3QgQVJSQVk6IHN0cmluZyA9IFwiYXJyYXlcIjtcclxuZXhwb3J0IGNsYXNzIFJ4RHluYW1pY0Zvcm1CdWlsZGVyIHtcclxuICAgIHByaXZhdGUgZm9ybUNvbmZpZ3VyYXRpb246IER5bmFtaWNGb3JtQ29uZmlndXJhdGlvbjtcclxuICAgIGZvcm1Hcm91cChmaWVsZHM6IGFueVtdLCBkeW5hbWljRm9ybUNvbmZpZz86IER5bmFtaWNGb3JtQ29uZmlndXJhdGlvbik6IER5bmFtaWNGb3JtQnVpbGRDb25maWcge1xyXG4gICAgICAgIGxldCBub3RpZmljYXRpb25JZCA9IE5vdGlmaWNhdGlvblN0YXRlLm5vdGlmaWNhdGlvbklkKys7XHJcbiAgICAgICAgTm90aWZpY2F0aW9uU3RhdGUubm90aWZpY2F0aW9uc1tub3RpZmljYXRpb25JZF0gPSB7fTtcclxuICAgICAgICB0aGlzLmZvcm1Db25maWd1cmF0aW9uID0gZHluYW1pY0Zvcm1Db25maWcgfHwge307XHJcbiAgICAgICAgbGV0IGVudGl0eU9iamVjdDogeyBba2V5OiBzdHJpbmddOiBhbnkgfSA9IHt9O1xyXG4gICAgICAgIGxldCBmb3JtRmllbGRDb25maWdzID0gbmV3IEFycmF5PEZvcm1Db250cm9sQ29uZmlnPigpO1xyXG4gICAgICAgIGxldCBtb2RlbENvbmZpZyA9IHt9O1xyXG4gICAgICAgIGxldCBmb3JtR3JvdXAgPSBuZXcgUnhGb3JtR3JvdXAoe30sIGVudGl0eU9iamVjdCwge30sIHVuZGVmaW5lZCk7XHJcbiAgICAgICAgZmllbGRzLmZvckVhY2goKHgsIGkpID0+IHtcclxuICAgICAgICAgICAgaWYgKHgudHlwZSA9PSBBUlJBWSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVGb3JtQXJyYXkobW9kZWxDb25maWcsIHgsIEFwcGxpY2F0aW9uVXRpbC5nZXRSb290Rm9ybUdyb3VwKGZvcm1Hcm91cCkgYXMgUnhGb3JtR3JvdXAsIGVudGl0eU9iamVjdCwgbm90aWZpY2F0aW9uSWQpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbGV0IHNwbGl0TmFtZSA9IHgubmFtZS5zcGxpdCgnLicpO1xyXG4gICAgICAgICAgICAgICAgbGV0IG5hbWUgPSB4Lm5hbWU7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3BsaXROYW1lLmxlbmd0aCA+IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWVudGl0eU9iamVjdFtzcGxpdE5hbWVbMF1dKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0eU9iamVjdFtzcGxpdE5hbWVbMF1dID0ge307XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1Hcm91cC5hZGRDb250cm9sKHNwbGl0TmFtZVswXSwgbmV3IFJ4Rm9ybUdyb3VwKHt9LCBlbnRpdHlPYmplY3Rbc3BsaXROYW1lWzBdXSwge30sIHVuZGVmaW5lZCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3JtR3JvdXAgPSBmb3JtR3JvdXAuY29udHJvbHNbc3BsaXROYW1lWzBdXSBhcyBSeEZvcm1Hcm91cDtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGZvcm1Hcm91cC5jb250cm9sc1tzcGxpdE5hbWVbMF1dICE9IHVuZGVmaW5lZCAmJiBmb3JtR3JvdXAuY29udHJvbHNbc3BsaXROYW1lWzBdXSBpbnN0YW5jZW9mIFJ4Rm9ybUdyb3VwKSBcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9ybUdyb3VwID0gZm9ybUdyb3VwLmNvbnRyb2xzW3NwbGl0TmFtZVswXV0gYXMgUnhGb3JtR3JvdXA7XHJcbiAgICAgICAgICAgICAgICAgICAgbmFtZSA9IHNwbGl0TmFtZVsxXTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZVxyXG4gICAgICAgICAgICAgICAgICAgIGZvcm1Hcm91cCA9IEFwcGxpY2F0aW9uVXRpbC5nZXRSb290Rm9ybUdyb3VwKGZvcm1Hcm91cCkgYXMgUnhGb3JtR3JvdXA7XHJcbiAgICAgICAgICAgICAgICBsZXQgbW9kZWxJbnN0YW5jZSA9IHRoaXMuZ2V0RHluYW1pY01vZGVsSW5zdGFuY2UoeCwgbW9kZWxDb25maWcsIGVudGl0eU9iamVjdCwgbmFtZSwgbm90aWZpY2F0aW9uSWQpO1xyXG4gICAgICAgICAgICAgICAgZm9ybUdyb3VwLmFkZENvbnRyb2wobmFtZSwgbW9kZWxJbnN0YW5jZS5mb3JtQ29udHJvbCk7XHJcbiAgICAgICAgICAgICAgICBmb3JtRmllbGRDb25maWdzLnB1c2gobW9kZWxJbnN0YW5jZSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGlmICh0aGlzLmZvcm1Db25maWd1cmF0aW9uLmFkZGl0aW9uYWxDb25maWcpXHJcbiAgICAgICAgICAgIHRoaXMuZm9ybUNvbmZpZ3VyYXRpb24uYWRkaXRpb25hbENvbmZpZy5mb3JFYWNoKHQgPT4gdGhpcy5nZXRNb2RlbEluc3RhbmNlKHQsIG1vZGVsQ29uZmlnLCBub3RpZmljYXRpb25JZCkpO1xyXG4gICAgICAgIGxldCByb290Rm9ybUdyb3VwID0gQXBwbGljYXRpb25VdGlsLmdldFJvb3RGb3JtR3JvdXAoZm9ybUdyb3VwKSBhcyBSeEZvcm1Hcm91cDtcclxuICAgICAgICByb290Rm9ybUdyb3VwW1wibW9kZWxcIl0gPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgcmV0dXJuICB7XHJcbiAgICAgICAgICAgIGNvbnRyb2xzQ29uZmlnOiBtb2RlbENvbmZpZyxcclxuICAgICAgICAgICAgZm9ybUdyb3VwOiByb290Rm9ybUdyb3VwXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgXHJcblxyXG4gICAgcHJpdmF0ZSBjcmVhdGVGb3JtQXJyYXkobW9kZWxDb25maWc6IGFueSwgZmllbGQ6IHsgW2tleTogc3RyaW5nXTogYW55IH0sIGZvcm1Hcm91cDogUnhGb3JtR3JvdXAsIGVudGl0eU9iamVjdDogeyBba2V5OiBzdHJpbmddOiBhbnkgfSwgbm90aWZpY2F0aW9uSWQpIHtcclxuICAgICAgICBtb2RlbENvbmZpZ1tmaWVsZC5uYW1lXSA9IFtdO1xyXG4gICAgICAgIGVudGl0eU9iamVjdFtmaWVsZC5uYW1lXSA9IFtdO1xyXG4gICAgICAgIGxldCBmb3JtQXJyYXkgPSBuZXcgUnhGb3JtQXJyYXkoZW50aXR5T2JqZWN0W2ZpZWxkLm5hbWVdLCBbXSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKGZpZWxkLmNvbnRyb2xDb25maWdzKSB7XHJcbiAgICAgICAgICAgIGlmIChmaWVsZC5yb3dzKVxyXG4gICAgICAgICAgICBmaWVsZC5yb3dzLmZvckVhY2gocm93ID0+IHtcclxuICAgICAgICAgICAgICAgIGZvcm1BcnJheS5jb250cm9scy5wdXNoKHRoaXMuY3JlYXRlRHluYW1pY0Zvcm1Hcm91cChmaWVsZCwgbW9kZWxDb25maWdbZmllbGQubmFtZV0sIHRoaXMuZ2V0UmVmT2JqZWN0KGVudGl0eU9iamVjdFtmaWVsZC5uYW1lXSksIHJvdywgbm90aWZpY2F0aW9uSWQpKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgaWYgKGZpZWxkLm1pbmltdW1SZXBlYXRDb3VudCAmJiBmaWVsZC5taW5pbXVtUmVwZWF0Q291bnQgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgY291bnRMZWZ0ID0gZmllbGQubWluaW11bVJlcGVhdENvdW50IC0gKGZvcm1BcnJheS5jb250cm9scy5sZW5ndGgpXHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvdW50TGVmdDsgaSsrKVxyXG4gICAgICAgICAgICAgICAgICAgIGZvcm1BcnJheS5jb250cm9scy5wdXNoKHRoaXMuY3JlYXRlRHluYW1pY0Zvcm1Hcm91cChmaWVsZCwgbW9kZWxDb25maWdbZmllbGQubmFtZV0sIHRoaXMuZ2V0UmVmT2JqZWN0KGVudGl0eU9iamVjdFtmaWVsZC5uYW1lXSksIHsgZmllbGRzOiBbXSB9LCBub3RpZmljYXRpb25JZCkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuYWRkVHdvUHJvcChtb2RlbENvbmZpZ1tmaWVsZC5uYW1lXSwgZmllbGQsIGVudGl0eU9iamVjdFtmaWVsZC5uYW1lXSwgZm9ybUFycmF5LG5vdGlmaWNhdGlvbklkKTtcclxuICAgICAgICAgICAgZm9ybUdyb3VwLmFkZENvbnRyb2woZmllbGQubmFtZSwgZm9ybUFycmF5KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRSZWZPYmplY3QoZW50aXR5T2JqZWN0OmFueVtdKSB7XHJcbiAgICAgICAgbGV0IGpPYmplY3QgPSB7fTtcclxuICAgICAgICBlbnRpdHlPYmplY3QucHVzaChqT2JqZWN0KTtcclxuICAgICAgICByZXR1cm4gak9iamVjdDtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBhZGRUd29Qcm9wKG1vZGVsQ29uZmlnOiBhbnksIHgsIGVudGl0eU9iamVjdCwgZm9ybUFycmF5LG5vdGlmaWNhdGlvbklkKSB7XHJcbiAgICAgICAgbW9kZWxDb25maWcuX19wcm90b19fLmFkZEl0ZW0gPSAoKSA9PiB7XHJcbiAgICAgICAgICAgIGZvcm1BcnJheS5jb250cm9scy5wdXNoKHRoaXMuY3JlYXRlRHluYW1pY0Zvcm1Hcm91cCh4LCBtb2RlbENvbmZpZywgdGhpcy5nZXRSZWZPYmplY3QoZW50aXR5T2JqZWN0KSwgeyBmaWVsZHM6IFtdIH0sIG5vdGlmaWNhdGlvbklkKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBtb2RlbENvbmZpZy5fX3Byb3RvX18ucmVtb3ZlSXRlbSA9IChpbmRleDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgICAgIGZvcm1BcnJheS5yZW1vdmVBdChpbmRleCk7XHJcbiAgICAgICAgICAgIG1vZGVsQ29uZmlnLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY3JlYXRlRHluYW1pY0Zvcm1Hcm91cCh4LCBtb2RlbENvbmZpZywgZW50aXR5T2JqZWN0LCByb3csIG5vdGlmaWNhdGlvbklkKSB7XHJcbiAgICAgICAgbGV0IG5lc3RlZEZvcm1Hcm91cCA9IG5ldyBSeEZvcm1Hcm91cCh7fSwgZW50aXR5T2JqZWN0LCB7fSwgdW5kZWZpbmVkKTtcclxuICAgICAgICBsZXQgak9iamVjdCA9IHt9O1xyXG4gICAgICAgIG1vZGVsQ29uZmlnLnB1c2goak9iamVjdCk7XHJcbiAgICAgICAgT2JqZWN0LmtleXMoeC5jb250cm9sQ29uZmlncykuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgZmllbGQgPSByb3cuZmllbGRzLmZpbHRlcih4ID0+IHgubmFtZSA9PSBrZXkpWzBdO1xyXG4gICAgICAgICAgICBsZXQgZm9ybUNvbnRyb2xDb25maWcgPSB7IC4uLnguY29udHJvbENvbmZpZ3Nba2V5XSwgLi4ueyBuYW1lOiBrZXkgfSB9O1xyXG4gICAgICAgICAgICBpZiAoZmllbGQpXHJcbiAgICAgICAgICAgICAgICBmb3JtQ29udHJvbENvbmZpZyA9IHsgLi4uZm9ybUNvbnRyb2xDb25maWcsIC4uLmZpZWxkIH07XHJcbiAgICAgICAgICAgIGxldCBtb2RlbEluc3RhbmNlID0gdGhpcy5nZXREeW5hbWljTW9kZWxJbnN0YW5jZShmb3JtQ29udHJvbENvbmZpZywgak9iamVjdCwgZW50aXR5T2JqZWN0LCBrZXksIG5vdGlmaWNhdGlvbklkKTtcclxuICAgICAgICAgICAgbmVzdGVkRm9ybUdyb3VwLmFkZENvbnRyb2woa2V5LCBtb2RlbEluc3RhbmNlLmZvcm1Db250cm9sKTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIHJldHVybiBuZXN0ZWRGb3JtR3JvdXA7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRNb2RlbEluc3RhbmNlKHgsIG1vZGVsQ29uZmlnLCBub3RpZmljYXRpb25JZCkge1xyXG4gICAgICAgIGxldCBjb25maWdNb2RlbCA9ICh4Lm1vZGVsTmFtZSkgJiYgdGhpcy5mb3JtQ29uZmlndXJhdGlvbiAmJiB0aGlzLmZvcm1Db25maWd1cmF0aW9uLmNvbnRyb2xDb25maWdNb2RlbHMgPyB0aGlzLmZvcm1Db25maWd1cmF0aW9uLmNvbnRyb2xDb25maWdNb2RlbHMuZmlsdGVyKCh5KSA9PiB5Lm1vZGVsTmFtZSA9PSB4Lm1vZGVsTmFtZSlbMF0gOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgbGV0IG1vZGVsQXJndW1lbnRzID0gW3gsIG1vZGVsQ29uZmlnLCBub3RpZmljYXRpb25JZF07XHJcbiAgICAgICAgbGV0IG1vZGVsID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIGlmIChjb25maWdNb2RlbCkge1xyXG4gICAgICAgICAgICBtb2RlbCA9IGNvbmZpZ01vZGVsLm1vZGVsO1xyXG4gICAgICAgICAgICBpZiAoY29uZmlnTW9kZWwuYXJndW1lbnRzKVxyXG4gICAgICAgICAgICAgICAgY29uZmlnTW9kZWwuYXJndW1lbnRzLmZvckVhY2godCA9PiBtb2RlbEFyZ3VtZW50cy5wdXNoKHQpKTtcclxuICAgICAgICB9IGVsc2VcclxuICAgICAgICAgICAgbW9kZWwgPSBGb3JtQ29udHJvbENvbmZpZztcclxuICAgICAgICBsZXQgbW9kZWxJbnN0YW5jZSA9IGdldEluc3RhbmNlKG1vZGVsLCBtb2RlbEFyZ3VtZW50cyk7XHJcbiAgICAgICAgbW9kZWxDb25maWdbeC5uYW1lXSA9IG1vZGVsSW5zdGFuY2U7XHJcbiAgICAgICAgcmV0dXJuIG1vZGVsSW5zdGFuY2VcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldER5bmFtaWNNb2RlbEluc3RhbmNlKHgsIG1vZGVsQ29uZmlnLCBlbnRpdHlPYmplY3QsIG5hbWUsIG5vdGlmaWNhdGlvbklkKSB7XHJcbiAgICAgICAgbGV0IG1vZGVsSW5zdGFuY2UgPSB0aGlzLmdldE1vZGVsSW5zdGFuY2UoeCwgbW9kZWxDb25maWcsIG5vdGlmaWNhdGlvbklkKTtcclxuICAgICAgICBsZXQgdmFsaWRhdG9yczogVmFsaWRhdG9yRm5bXSA9IFtdO1xyXG4gICAgICAgIGxldCBhc3luY1ZhbGlkYXRvcnM6IEFzeW5jVmFsaWRhdG9yRm5bXSA9IFtdO1xyXG4gICAgICAgIGlmICh4LnZhbGlkYXRvcnMpXHJcbiAgICAgICAgICAgIHRoaXMudmFsaWRhdG9yQmluZGluZ3ModmFsaWRhdG9ycywgeC52YWxpZGF0b3JzKTtcclxuICAgICAgICBpZiAobW9kZWxJbnN0YW5jZS52YWxpZGF0b3IpXHJcbiAgICAgICAgICAgIHZhbGlkYXRvcnMucHVzaChtb2RlbEluc3RhbmNlLnZhbGlkYXRvci5iaW5kKG1vZGVsSW5zdGFuY2UpKTtcclxuICAgICAgICBpZiAobW9kZWxJbnN0YW5jZS5hc3luY1ZhbGlkYXRvcilcclxuICAgICAgICAgICAgYXN5bmNWYWxpZGF0b3JzLnB1c2gobW9kZWxJbnN0YW5jZS5hc3luY1ZhbGlkYXRvci5iaW5kKG1vZGVsSW5zdGFuY2UpKTtcclxuICAgICAgICBpZiAobW9kZWxJbnN0YW5jZSlcclxuICAgICAgICAgICAgZW50aXR5T2JqZWN0W3gubmFtZV0gPSB4LnZhbHVlO1xyXG4gICAgICAgIGxldCBiYXNlT2JqZWN0ID0ge307XHJcbiAgICAgICAgYmFzZU9iamVjdFt4Lm5hbWVdID0geC52YWx1ZTtcclxuICAgICAgICBlbnRpdHlPYmplY3RbeC5uYW1lXSA9IHgudmFsdWU7XHJcbiAgICAgICAgbW9kZWxJbnN0YW5jZS5mb3JtQ29udHJvbCA9IG5ldyBSeEZvcm1Db250cm9sKHgudmFsdWUsIHZhbGlkYXRvcnMsIGFzeW5jVmFsaWRhdG9ycywgZW50aXR5T2JqZWN0LCBiYXNlT2JqZWN0LCBuYW1lLCB1bmRlZmluZWQpO1xyXG4gICAgICAgIHJldHVybiBtb2RlbEluc3RhbmNlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdmFsaWRhdG9yQmluZGluZ3ModmFsaWRhdGlvbnM6IGFueVtdLCB2YWxpZGF0aW9uQ29uZmlnOiBhbnkpIHtcclxuICAgICAgICBmb3IgKHZhciBjb2x1bW4gaW4gUnh3ZWJWYWxpZGF0b3JzKSB7XHJcbiAgICAgICAgICAgIGlmICh2YWxpZGF0aW9uQ29uZmlnW2NvbHVtbl0pIHtcclxuICAgICAgICAgICAgICAgIHZhbGlkYXRpb25zLnB1c2goUnh3ZWJWYWxpZGF0b3JzW2NvbHVtbl0odmFsaWRhdGlvbkNvbmZpZ1tjb2x1bW5dKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHZhbGlkYXRpb25zO1xyXG4gICAgfVxyXG59Il19